<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <title>iiif Parallax Viewer</title>
  <style type="text/css">
    html, body { height:100%; margin:0; }
    body { background:#000; font:14px/1 helvetica,arial,freesans,sans-serif; }
    .parallaxer { height:100%; width:100%; }
  </style>	
</head>

<body>

<div class="parallaxer js-parallaxer"></div>

<script src="img/manifesto.bundle.js"></script>
<script src="img/openseadragon.min.js"></script>
<script type="text/javascript">
const viewer = {
  id: 1,
  init: (el) => {
    el.id = el.id || 'viewer' + viewer.id++;
    el.osd = OpenSeadragon({
      id: el.id,
      showNavigationControl: false,
      zoomPerClick: 1.05,
      zoomPerScroll: 1.05,
      minZoomLevel: 0.5,
      maxZoomLevel: 4,
      gestureSettingsMouse: {
        zoomToRefPoint: false,
        flickEnabled: false
      }
    });
    el.osd.world.addHandler('add-item', (data) => {
      const scaler = 0.1;
      data.item.source.tileFormat = 'png';
      el.panZero = el.osd.viewport.getCenter();
      el.stackHeight = el.osd.world.getItemCount();
      el.osd.world.setItemIndex(data.item, 0);
      if (el.stackHeight > 1) {
        for (let i = 0; i < el.stackHeight; i++) {
        const item = el.osd.world.getItemAt(i);
          item.setWidth((1 / el.stackHeight) + (i / el.stackHeight));
          item.setPosition(
            new OpenSeadragon.Point(
              el.panZero.x - (item.getBounds().width / 2),
              el.panZero.y - (item.getBounds().height / 2)
            )
          );
        }
      }
      //~ el.osd.viewport.panTo(el.osd.world.getHomeBounds().getCenter());
      el.osdZoom = el.osd.viewport.getZoom();
      el.osd.viewport.minZoomImageRatio = el.osdZoom;
    });
    el.osd.addHandler('pan', (data) => {
      const scaler = 8;
      for (let i = 1; i < el.stackHeight; i++) {
        el.osd.world.getItemAt(i).setPosition(
          new OpenSeadragon.Point(
            -i * i * (data.center.x - el.panZero.x) / scaler,
            -i * i * (data.center.y - el.panZero.y) / scaler
          )
        );
      }
    });
    el.osd.addHandler('zoom', (data) => {
      const scaler = 0.005;
      const vector = data.zoom > el.osdZoom ? 1 : -1;
      el.osdZoom = data.zoom;
      for (let i = 0; i < el.stackHeight; i++) {
        const item = el.osd.world.getItemAt(i);
        const w = item.getBounds().width;
        const wDelta = i * i * scaler * vector;
        item.setWidth(w + wDelta);
        item.setPosition(
          item.imageToViewportCoordinates(
            item.getBounds().x - (wDelta / 2),
            item.getBounds().y - (wDelta / 2)
            * item.getBounds().height / item.getBounds().width,
          )
        );
      }
    });
  }
};

const parallaxer = document.querySelector(".js-parallaxer");

const qstr = new Map(location.search.slice(1).split('&').map(kv => kv.split('=')));
let m = 'img/manifest_peepshow.json';

if (!qstr.has('manifest')) {
  document.location.search = 'manifest=' + m;
} else {
  m = qstr.get('manifest');
}
manifesto.loadManifest(m).then((manifest) => {
  const mf = manifesto.create(manifest);
  const cvs = mf.getSequences()[0].getCanvases();
  let img = null;
  viewer.init(parallaxer);
  Array.from(cvs, (cv) => {
    /* P3 manifest, else P2 */
    if (cv.getImages().length) {
      img = cv.getImages()[0].getResource().getServices()[0].id;
    } else if (cv.getContent().length) {
      img = cv.getContent()[0].getBody()[0].getServices()[0].id;
    }
    if (img) {
      parallaxer.osd.addTiledImage({
        tileSource: `${img}/info.json`
      });
    }
  });
});
</script>
</body>
</html>
